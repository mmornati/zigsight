---
name: Integration Test

'on':
  workflow_dispatch:
    inputs:
      ha_version:
        description: 'Home Assistant version to test against'
        required: false
        default: 'latest'

permissions:
  contents: read

jobs:
  docker-integration-test:
    name: Docker Integration Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Start Home Assistant Container
        run: |
          echo "Starting Home Assistant ${{ github.event.inputs.ha_version || 'latest' }}..."
          HA_VERSION="${{ github.event.inputs.ha_version || 'latest' }}"
          HA_IMAGE="homeassistant/home-assistant:${HA_VERSION}"

          mkdir -p "${GITHUB_WORKSPACE}/test_config"

          docker run -d \
            --name ha-test \
            --network host \
            -v "${GITHUB_WORKSPACE}/custom_components/zigsight:/config/custom_components/zigsight:ro" \
            -v "${GITHUB_WORKSPACE}/test_config:/config" \
            "$HA_IMAGE"

          echo "Container started with image: $HA_IMAGE"

      - name: Wait for Home Assistant to be ready
        run: |
          echo "Waiting for Home Assistant to start..."
          timeout=180
          elapsed=0

          while [ "$elapsed" -lt "$timeout" ]; do
            if curl -sf http://localhost:8123 > /dev/null 2>&1; then
              echo "✓ Home Assistant is ready!"
              break
            fi
            sleep 5
            elapsed=$((elapsed + 5))
          done

          if [ "$elapsed" -ge "$timeout" ]; then
            echo "✗ Home Assistant failed to start within ${timeout}s"
            docker logs ha-test
            exit 1
          fi

      - name: Verify Integration
        run: |
          echo "Verifying integration..."
          docker exec ha-test test -f /config/custom_components/zigsight/manifest.json || {
            echo "✗ Integration manifest not found"
            exit 1
          }
          echo "✓ Integration files verified"

      - name: Check for Errors
        run: |
          sleep 10
          if docker logs ha-test 2>&1 | grep -i "importerror\|modulenotfounderror\|syntaxerror" | grep -i "zigsight"; then
            echo "✗ Found errors in logs"
            docker logs ha-test | grep -i "zigsight"
            exit 1
          fi
          echo "✓ No errors detected"

      - name: Stop container
        if: always()
        run: |
          docker stop ha-test || true
          docker rm ha-test || true
